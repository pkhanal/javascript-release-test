/**
 * Copyright (c) 2007-2014 Kaazing Corporation. All rights reserved.
 * 
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *   http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
var XDRHttpDirect=function(){function a(a){this.outer=a}var b=0,c=a.prototype;return c.open=function(a,b){var c=this,d=this.outer;d.responseText="";var e=2,f=0,g=0;this._method=a,this._location=b,b+=-1==b.indexOf("?")?"?.kac=ex&.kct=application/x-message-http":"&.kac=ex&.kct=application/x-message-http",this.location=b;var h=this.xdr=new XDomainRequest,i=function(a){try{var b=h.responseText;if(2>=e){var i=b.indexOf("\r\n\r\n");if(-1==i)return;var j=b.indexOf("\r\n"),k=b.substring(0,j),l=k.match(/HTTP\/1\.\d\s(\d+)\s([^\r\n]+)/);d.status=parseInt(l[1]),d.statusText=l[2];var m=j+2;g=i+4;var n=b.substring(m,i).split("\r\n");d._responseHeaders={};for(var o=0;o<n.length;o++){var p=n[o].split(":");d._responseHeaders[p[0].replace(/^\s+|\s+$/g,"")]=p[1].replace(/^\s+|\s+$/g,"")}f=g,e=d.readyState=3,"function"==typeof c.onreadystatechange&&c.onreadystatechange(d)}var q=h.responseText.length;q>f&&(d.responseText=b.slice(g),f=q,"function"==typeof c.onprogress&&c.onprogress(d))}catch(r){c.onload(d)}};h.onprogress=i,h.onerror=function(a){d.readyState=0,"function"==typeof d.onerror&&d.onerror(d)},h.onload=function(a){3>=e&&i(a),reayState=d.readyState=4,"function"==typeof d.onreadystatechange&&d.onreadystatechange(d),"function"==typeof d.onload&&d.onload(d)},h.open("POST",b)},c.send=function(a){for(var b=this._method+" "+this.location.substring(this.location.indexOf("/",9),this.location.indexOf("&.kct"))+" HTTP/1.1\r\n",c=0;c<this.outer._requestHeaders.length;c++)b+=this.outer._requestHeaders[c][0]+": "+this.outer._requestHeaders[c][1]+"\r\n";var d=a||"";if(d.length>0||"POST"===this._method.toUpperCase()){for(var e=0,c=0;c<d.length;c++)e++,d.charCodeAt(c)>=128&&e++;b+="Content-Length: "+e+"\r\n"}b+="\r\n",b+=d,this.xdr.send(b)},c.abort=function(){this.xdr.abort()},a}(),XMLHttpBridge=function(){function a(a){this.outer=a}function b(a){switch("undefined"!=typeof a.onreadystatechange&&a.onreadystatechange(a.outer),a.outer.readyState){case 3:"undefined"!=typeof a.onprogress&&a.onprogress(a.outer);break;case 4:a.outer.status<100||a.outer.status>=500?"undefined"!=typeof a.onerror&&a.onerror(a.outer):("undefined"!=typeof a.onprogress&&a.onprogress(a.outer),"undefined"!=typeof a.onload&&a.onload(a.outer))}}function c(a){return parseInt(a,16)}function d(a,b){var c=a.toString(16),d=[];for(b-=c.length;b-->0;)d.push("0");return d.push(c),d.join("")}function e(a){var b=d(m++,8);return l[b]=a,a._id=b,b}function f(a,b){"string"!=typeof b&&(b="");for(var c=a._method.substring(0,10),e=a._location,f=a.outer._requestHeaders,g=d(a.outer.timeout,4),h=void 0!==a.outer.onprogress?"t":"f",i=["s",a._id,c.length,c,d(e.length,4),e,d(f.length,4)],j=0;j<f.length;j++){var k=f[j];i.push(d(k[0].length,4)),i.push(k[0]),i.push(d(k[1].length,4)),i.push(k[1])}i.push(d(b.length,8),b,d(g,4),h),a._pipe.post(i.join(""))}function g(a,c){function d(a){this.buffer.push(a)}function e(a){var b=this.attached[a];void 0===b&&(b={},this.attached[a]=b),void 0!==b.timerID&&(clearTimeout(b.timerID),delete b.timerID)}function f(a){var b=this.attached[a];if(void 0!==b&&void 0===b.timerID){var c=this;b.timerID=setTimeout(function(){delete c.attached[a];var b=l[a];b._pipe==q&&(delete l[a],delete b._id,delete b._pipe),postMessage0(q.iframe.contentWindow,["d",a].join(""),q.targetOrigin)},0)}}function g(){var a=r.contentWindow;a?postMessage0(a,"I",p):setTimeout(g,20)}var h=new URI(c),m=null!=h.scheme&&null!=h.authority,n=m?h.scheme:i.scheme,o=m?h.authority:i.authority;null!=o&&null==h.port&&(o=h.host+":"+j[n]);var p=n+"://"+o,q=k[p];if(void 0!==q&&("iframe"in q&&"contentWindow"in q.iframe&&"object"==typeof q.iframe.contentWindow||(q=k[p]=void 0)),void 0===q){var r=document.createElement("iframe");r.style.position="absolute",r.style.left="-10px",r.style.top="10px",r.style.visibility="hidden",r.style.width="0px",r.style.height="0px";var s=new URI(p);s.query=".kr=xs",s.path="/",r.src=s.toString(),q={targetOrigin:p,iframe:r,buffer:[],post:d,attach:e,detach:f,attached:{count:0}},k[p]=q,q.handshakeID=setTimeout(function(){k[p]=void 0,q.post=function(c){a.readyState=4,a.status=0,b(a)},q.buffer.length>0&&q.post()},3e4),document.body.appendChild(r),"undefined"==typeof postMessage&&g()}return q}function h(a){var d=a.origin,h={http:":80",https:":443"},i=d.split(":");2===i.length&&(d+=h[i[0]]);var j=k[d];if(void 0!==j&&void 0!==j.iframe&&a.source==j.iframe.contentWindow)if("I"==a.data){clearTimeout(j.handshakeID);for(var m;void 0!==(m=j.buffer.shift());)postMessage0(j.iframe.contentWindow,m,j.targetOrigin);j.post=function(a){postMessage0(j.iframe.contentWindow,a,j.targetOrigin)}}else{var m=a.data;if(m.length>=9){var n=0,o=m.substring(n,n+=1),p=m.substring(n,n+=8),q=l[p];if(void 0!==q)switch(o){case"r":for(var r={},s=c(m.substring(n,n+=2)),t=0;s>t;t++){var u=c(m.substring(n,n+=4)),v=m.substring(n,n+=u),w=c(m.substring(n,n+=4)),x=m.substring(n,n+=w);r[v]=x}var y=c(m.substring(n,n+=4)),z=c(m.substring(n,n+=2)),A=m.substring(n,n+=z);switch(y){case 301:case 302:case 307:var B=r.Location,C=a.origin;if("function"==typeof q.outer.onredirectallowed&&!q.outer.onredirectallowed(C,B))return;var p=e(q),j=g(q,B);j.attach(p),q._pipe=j,q._method="GET",q._location=B,q._redirect=!0;break;case 403:q.outer.status=y,b(q);break;default:q.outer._responseHeaders=r,q.outer.status=y,q.outer.statusText=A}break;case"p":var D=parseInt(m.substring(n,n+=1));if(q._id===p){q.outer.readyState=D;var E=c(m.substring(n,n+=8)),F=m.substring(n,n+=E);F.length>0&&(q.outer.responseText+=F),b(q)}else q._redirect&&(q._redirect=!1,f(q,""));4==D&&j.detach(p);break;case"e":q._id===p&&(q.outer.status=0,q.outer.statusText="",q.outer.readyState=4,b(q)),j.detach(p);break;case"t":q._id===p&&(q.outer.status=0,q.outer.statusText="",q.outer.readyState=4,"undefined"!=typeof q.ontimeout&&q.ontimeout()),j.detach(p)}}}}var i=new URI("ie"==browser?document.URL:location.href),j={http:80,https:443};null==i.port&&(i.port=j[i.scheme],i.authority=i.host+":"+i.port);var k={},l={},m=0,n=a.prototype;return n.open=function(a,c){var d=e(this),f=g(this,c);f.attach(d),this._pipe=f,this._method=a,this._location=c,this.outer.readyState=1,this.outer.status=0,this.outer.statusText="",this.outer.responseText="";var h=this;setTimeout(function(){h.outer.readyState=1,b(h)},0)},n.send=function(a){f(this,a)},n.abort=function(){var a=this._pipe;void 0!==a&&(a.post(["a",this._id].join("")),a.detach(this._id))},window.addEventListener("message",h,!1),a}(),XMLHttpRequest0=function(){function a(a){"undefined"!=typeof a.onreadystatechange&&a.onreadystatechange()}function b(a){"undefined"!=typeof a.onprogress&&a.onprogress()}function c(a){"undefined"!=typeof a.onerror&&a.onerror()}function d(a){"undefined"!=typeof a.onload&&a.onload()}function e(){this._requestHeaders=[],this.responseHeaders={},this.withCredentials=!1}var f=new URI("ie"==browser?document.URL:location.href),g={http:80,https:443};null==f.port&&(f.port=g[f.scheme],f.authority=f.host+":"+f.port);var h=e.prototype;return h.readyState=0,h.responseText="",h.status=0,h.statusText="",h.timeout=0,h.onreadystatechange,h.onerror,h.onload,h.onprogress,h.onredirectallowed,h.open=function(e,h,i){if(!i)throw new Error("Asynchronous is required for cross-origin XMLHttpRequest emulation");switch(this.readyState){case 0:case 4:break;default:throw new Error("Invalid ready state")}var j=this;this._method=e,this._location=h,this.readyState=1,this.status=0,this.statusText="",this.responseText="";var k,l=new URI(h);if(null==l.port&&(l.port=g[l.scheme],l.authority=l.host+":"+l.port),"ie"!=browser||"undefined"==typeof XDomainRequest||l.scheme!=f.scheme||this.withCredentials)if(l.scheme==f.scheme&&l.authority==f.authority)try{k=new XMLHttpBridge(this)}catch(m){k=new XMLHttpBridge(this)}else k=new XMLHttpBridge(this);else k=new XDRHttpDirect(this);k.onload=d,k.onprogress=b,k.onreadystatechange=a,k.onerror=c,k.open(e,h),this.xhr=k,setTimeout(function(){j.readyState>1||(j.readyState<1&&(j.readyState=1),a(j))},0)},h.setRequestHeader=function(a,b){if(1!==this.readyState)throw new Error("Invalid ready state");this._requestHeaders.push([a,b])},h.send=function(b){if(1!==this.readyState)throw new Error("Invalid ready state");var c=this;setTimeout(function(){c.readyState>2||(c.readyState<2&&(c.readyState=2),a(c))},0),this.xhr.send(b)},h.abort=function(){this.xhr.abort()},h.getResponseHeader=function(a){if(0==this.status)throw new Error("Invalid ready state");var b=this._responseHeaders;return b[a]},h.getAllResponseHeaders=function(){if(0==this.status)throw new Error("Invalid ready state");return this._responseHeaders},e}();